# Deployment

This guide covers deploying Zodula applications to production environments. We'll cover different deployment strategies, configuration, and best practices for production deployments.

## Production Requirements

### System Requirements

- **Bun v1.2.x+** - Runtime environment
- **PostgreSQL 12+** - Database (recommended)
- **Redis 6+** - Session storage and caching
- **Node.js 18+** - For some build tools (optional)

### Environment Variables

```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/zodula_app

# Redis
REDIS_URL=redis://localhost:6379

# Security
SESSION_SECRET=your-super-secret-session-key
JWT_SECRET=your-jwt-secret-key

# Application
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# File Storage
STORAGE_PATH=/var/lib/zodula/files
MAX_FILE_SIZE=10485760

# Email (optional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
```

## Docker Deployment

### Dockerfile

```dockerfile
# Use Bun official image
FROM oven/bun:1.2-alpine

# Set working directory
WORKDIR /app

# Copy package files
COPY package.json bun.lockb ./

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source code
COPY . .

# Build the application
RUN bun run build

# Expose port
EXPOSE 3000

# Start the application
CMD ["bun", "run", "start"]
```

### Docker Compose

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/zodula_app
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    volumes:
      - ./files:/var/lib/zodula/files

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=zodula_app
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/var/lib/redis/data
    ports:
      - "6379:6379"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

volumes:
  postgres_data:
  redis_data:
```

### Nginx Configuration

```nginx
upstream app {
    server app:3000;
}

server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # File upload size
    client_max_body_size 50M;

    location / {
        proxy_pass http://app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Static files
    location /files {
        alias /var/lib/zodula/files;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

## Cloud Deployment

### Railway

1. **Connect Repository**
   ```bash
   # Install Railway CLI
   npm install -g @railway/cli
   
   # Login and deploy
   railway login
   railway link
   railway up
   ```

2. **Environment Variables**
   ```bash
   railway variables set DATABASE_URL=postgresql://...
   railway variables set REDIS_URL=redis://...
   railway variables set SESSION_SECRET=your-secret
   ```

### Vercel

1. **vercel.json**
   ```json
   {
     "version": 2,
     "builds": [
       {
         "src": "index.ts",
         "use": "@vercel/node"
       }
     ],
     "routes": [
       {
         "src": "/(.*)",
         "dest": "index.ts"
       }
     ]
   }
   ```

2. **Deploy**
   ```bash
   npm install -g vercel
   vercel --prod
   ```

### DigitalOcean App Platform

1. **Create app.yaml**
   ```yaml
   name: zodula-app
   services:
   - name: web
     source_dir: /
     github:
       repo: your-username/your-repo
       branch: main
     run_command: bun run start
     environment_slug: bun
     instance_count: 1
     instance_size_slug: basic-xxs
     envs:
     - key: NODE_ENV
       value: production
     - key: DATABASE_URL
       value: ${db.DATABASE_URL}
   databases:
   - name: db
     engine: PG
     version: "15"
   ```

## Database Setup

### PostgreSQL Configuration

```sql
-- Create database
CREATE DATABASE zodula_app;

-- Create user
CREATE USER zodula_user WITH PASSWORD 'secure_password';

-- Grant permissions
GRANT ALL PRIVILEGES ON DATABASE zodula_app TO zodula_user;
```

### Database Migrations

```bash
# Run migrations in production
nailgun migrate

# Backup database
pg_dump -h localhost -U zodula_user zodula_app > backup.sql

# Restore database
psql -h localhost -U zodula_user zodula_app < backup.sql
```

## Production Configuration

### Application Configuration

```typescript
// config/production.ts
export default {
  database: {
    url: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === "production" ? { rejectUnauthorized: false } : false
  },
  
  redis: {
    url: process.env.REDIS_URL
  },
  
  security: {
    sessionSecret: process.env.SESSION_SECRET,
    jwtSecret: process.env.JWT_SECRET,
    cors: {
      origin: process.env.ALLOWED_ORIGINS?.split(",") || ["https://yourdomain.com"],
      credentials: true
    }
  },
  
  fileStorage: {
    path: process.env.STORAGE_PATH || "/var/lib/zodula/files",
    maxFileSize: parseInt(process.env.MAX_FILE_SIZE || "10485760")
  },
  
  email: {
    host: process.env.SMTP_HOST,
    port: parseInt(process.env.SMTP_PORT || "587"),
    user: process.env.SMTP_USER,
    password: process.env.SMTP_PASSWORD
  }
}
```

### Performance Optimization

```typescript
// Enable production optimizations
export default {
  performance: {
    // Enable compression
    compression: true,
    
    // Enable caching
    cache: {
      enabled: true,
      ttl: 3600 // 1 hour
    },
    
    // Database connection pooling
    database: {
      pool: {
        min: 2,
        max: 10,
        acquireTimeoutMillis: 30000,
        createTimeoutMillis: 30000,
        destroyTimeoutMillis: 5000,
        idleTimeoutMillis: 30000,
        reapIntervalMillis: 1000,
        createRetryIntervalMillis: 200
      }
    }
  }
}
```

## Monitoring and Logging

### Application Monitoring

```typescript
// Enable monitoring
import { monitor } from '@zodula/monitoring'

const app = monitor({
  metrics: {
    enabled: true,
    endpoint: '/metrics'
  },
  
  health: {
    enabled: true,
    endpoint: '/health'
  },
  
  logging: {
    level: 'info',
    format: 'json'
  }
})
```

### Health Checks

```typescript
// Health check endpoint
app.get('/health', async (req, res) => {
  try {
    // Check database connection
    await $zodula.db.query('SELECT 1');
    
    // Check Redis connection
    await $zodula.redis.ping();
    
    res.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime()
    });
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      error: error.message
    });
  }
});
```

### Logging Configuration

```typescript
// Winston logger configuration
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});
```

## Security Hardening

### Security Headers

```typescript
// Security middleware
import helmet from 'helmet';

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'"],
      fontSrc: ["'self'"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'none'"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

### Rate Limiting

```typescript
// Rate limiting configuration
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: 'Too many requests from this IP, please try again later.',
  standardHeaders: true,
  legacyHeaders: false
});

app.use('/api/', limiter);
```

## Backup and Recovery

### Automated Backups

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/zodula"
DB_NAME="zodula_app"

# Create backup directory
mkdir -p $BACKUP_DIR

# Database backup
pg_dump -h localhost -U zodula_user $DB_NAME > $BACKUP_DIR/db_$DATE.sql

# File backup
tar -czf $BACKUP_DIR/files_$DATE.tar.gz /var/lib/zodula/files

# Cleanup old backups (keep 30 days)
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
```

### Recovery Process

```bash
#!/bin/bash
# restore.sh

BACKUP_DATE=$1
BACKUP_DIR="/var/backups/zodula"

if [ -z "$BACKUP_DATE" ]; then
    echo "Usage: $0 <backup_date>"
    exit 1
fi

# Restore database
psql -h localhost -U zodula_user zodula_app < $BACKUP_DIR/db_$BACKUP_DATE.sql

# Restore files
tar -xzf $BACKUP_DIR/files_$BACKUP_DATE.tar.gz -C /

echo "Restore completed: $BACKUP_DATE"
```

## Scaling

### Horizontal Scaling

```yaml
# docker-compose.scale.yml
version: '3.8'

services:
  app:
    build: .
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/zodula_app
      - REDIS_URL=redis://redis:6379
    deploy:
      replicas: 3
    depends_on:
      - db
      - redis

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - app
```

### Load Balancer Configuration

```nginx
upstream app {
    least_conn;
    server app_1:3000;
    server app_2:3000;
    server app_3:3000;
}

server {
    listen 80;
    server_name yourdomain.com;
    
    location / {
        proxy_pass http://app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
